---
title: "MockParker1986Equation"
author: "Ivan Bizberg"
date: "11/16/2020"
output: html_document
bibliography: C:/Users/ivan/Dropbox/ZoteroMyLibrary.bib
link-citations: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Equation from [@mock_advantages_1986]

RVe = q * P; 

RVi = (1 - q).Pi  

q Proporción de nidadas en las que el hermano mayor no falleció antes que el hermano menor.  
q Proporción de nidadas en las que el hermano menor falleció antes que el hermano mayor  

P; es la fracción de q en la que sobrevive el más joven 

Pi es la fracción de los más jóvenes que sobrevive en las otras 1 - q nidadas. 

RVe: extra reproductive value 

RVi: insurance reproductive value

## Libraries
```{r, include=FALSE}
library(tidyverse)
library(lubridate)
library(png)
library(gt)
library(kableExtra)
library(ghibli)
library(ggpubr)
library(asbio) # Confidence interval for the product of two proportions 
library(rsample)
library(mosaic)

path = "Conducta"

source(str_glue("C:/Users/{path}/Dropbox/PHD/Custom functions/Censoring.R"))

setwd(str_glue("C:/Users/{path}/Dropbox/PHD/Git/Calculate_MarginalValue/"))

# DATA
RAW_DAT = read.csv(str_glue("C:/Users/{path}/Dropbox/PHD/DATA/RawData4.5.csv"),sep =",",header = T) %>% mutate(across(c(ESTECLOS1), ymd))
RAW_CLIM = read.csv(str_glue("C:/Users/{path}/Dropbox/PHD/DATA/ClimateVariables4.0.csv"),sep =",",header = T) %>%  mutate(across(c(time), ymd)) %>% arrange(time) %>% 
  mutate(SST = as.numeric(SST)) %>% glimpse()


# Edit data
Periode_SST <- RAW_DAT %>% select(NIDO, ESTECLOS1) %>%  
  mutate(EstLay = ESTECLOS1 - 40, EstFledg = ESTECLOS1 + 60) %>% rowwise() %>% 
  mutate(listSST = list(RAW_CLIM$SST[RAW_CLIM$time %within% interval(EstLay, EstFledg)])) %>% 
  ungroup() %>% 
  mutate(
    Periode_SST = map_dbl(listSST, mean, na.rm = T)) %>% 
  mutate(Periode_roundSST = round(Periode_SST, digits = 0)) %>% 
  select(NIDO, Periode_SST, Periode_roundSST)



RAW_DATA <- RAW_DAT %>% left_join(., Periode_SST, by = "NIDO") %>% 
  mutate(Periode_roundPrRank = round(PROPORTIONALRANK, digits = 1)) %>% 
  glimpse()
```



# Brood of 2

### Filter data

```{r}
Data <- RAW_DATA %>% 
  filter(NIDADA == 2, PUESTA == 2, SEMANIPULO == "f") %>% Censoring(., 60) 

Sample_size_2 <- Data %>% count() %>% pull
  
Tab <- Data %>% mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>% 
  mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>% 
  mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>% 
  count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n)) 



Tab %>% mutate(across(everything(), as.character)) %>% 
  pivot_longer(-n) %>% stack() 





## Values

Total <- Tab$Total[1]
q <- Tab %>% filter(q == "A dind't died before B (q)") %>% pull(Sum_q) %>% .[1]
P <- Tab %>% filter(q == "A dind't died before B (q)" & P == "Both survived") %>% pull(n)

`Total-q` <- Total - q
Pi <- Tab %>% filter(Pi == "B survived after A died") %>% pull(n)





## Mock equation

RVe_2 <- round(q/Total * P/q, digits = 3); RVe_2

RVi_2 <- round((1 - q/Total) * Pi/`Total-q`, digits = 3); RVi_2

TotRV_2 <- RVe_2 + RVi_2

### Percentage
`%RVe` <- RVe_2 * 100 / TotRV_2; `%RVe`
`%RVi` <- RVi_2 * 100 / TotRV_2; `%RVi`

## Results

FinalRV_2 <- data.frame(RV = c("RVe", "RVi"),
                  Reproductive_Value = c(RVe_2, RVi_2),
                  Perc = c(`%RVe`, `%RVi`))
```


# Brood of 3

### Filter data

```{r}

Data <- RAW_DATA %>% 
  filter(NIDADA == 3, PUESTA == 3, SEMANIPULO == "f") %>% Censoring(., 60)

Sample_size_3 <- Data %>% count() %>% pull
  
Tab <- Data %>% mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~ 
                         "A and B dind't died before C (q)")) %>% 
  mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>% 
  mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>% 
  select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>% 
  count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n)) 

Tab %>% mutate(across(everything(), as.character)) %>% 
  pivot_longer(-n) %>% stack() 



## Values

Total <- Tab$Total[1]
q <- Tab %>% filter(q == "A and B dind't died before C (q)") %>% pull(Sum_q) %>% .[1]
P <- Tab %>% filter(q == "A and B dind't died before C (q)" & P == "All survived") %>% pull(n)

`Total-q` <- Total - q
Pi <- Tab %>% filter(Pi == "C survived after A or B died") %>% pull(n)





## Mock equation

RVe_3 <- round(q/Total * P/q, digits = 3); RVe_3

RVi_3 <- round((1 - q/Total) * Pi/`Total-q`, digits = 3); RVi_3

TotRV_3 <- RVe_3+ RVi_3

### Percentage
`%RVe` <- RVe_3 * 100 / TotRV_3; `%RVe`
`%RVi` <- RVi_3 * 100 / TotRV_3; `%RVi`
## Results

FinalRV_3 <- data.frame(RV = c("RVe", "RVi"),
                  Reproductive_Value = c(RVe_3, RVi_3),
                  Perc = c(`%RVe`, `%RVi`))
```


# Export table results
```{r}

Marginal_value <- data.frame(
  `Reproductive value` = c("RVe", "RVi"),
  `Brood 2` = c(RVe_2, RVi_2),
  `Brood 3` = c(RVe_3, RVi_3)) %>% 
  kbl(col.names = c("Reproductive value", "two (n = 5645)", "three (n = 1362)"), align = c("l", "c", "c")) %>%
  kable_styling(latex_options = c("striped", "hold_position"),
                full_width = FALSE) %>% add_header_above(c(" " = 1, "Brood size" = 2)) %>% 
  kable_classic(full_width = F, html_font = "Cambria") %>% 
  save_kable("Reproductive_Value_results.png", zoom = 10)
```





# CI RV for broods of 2 and 3



# Brood of 2
```{r}
Data <- RAW_DATA %>% 
  filter(NIDADA == 2, PUESTA == 2, SEMANIPULO == "f")

CIBootLoop <- data.frame()

for (i in 1:1e2) {
  
  
  Datas <- resample(Data, replace = TRUE)
  
  
  RV <- Datas %>% mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>% 
    mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>% 
    mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>% 
    count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n)) 
  
  
  
  
  
  Total <- RV$Total[1]
  q <- RV %>% filter(q == "A dind't died before B (q)") %>% pull(Sum_q) %>% .[1]
  P <- RV %>% filter(q == "A dind't died before B (q)" & P == "Both survived") %>% pull(n)
  
  `Total-q` <- Total - q
  Pi <- RV %>% filter(Pi == "B survived after A died") %>% pull(n)
  
  
  
  ### Percentage
  `%RVe` <- RVe * 100 / TotRV; `%RVe`
  `%RVi` <- RVi * 100 / TotRV; `%RVi`
  
  
  RVe_2 <- round(q/Total * P/q, digits = 3); RVe_2
  
  RVi_2 <- round((1 - q/Total) * Pi/`Total-q`, digits = 3); RVi_2
  
  dat <- data.frame(RV = c("RVe", "RVi"),
                    Reproductive_Value = c(RVe_2, RVi_2),
                    Perc = c(`%RVe`, `%RVi`))
  
  CIBootLoop <- rbind(CIBootLoop, dat)
}

CI <- CIBootLoop %>% group_by(RV) %>% 
  summarise(se = sd(Reproductive_Value), CI = 2 * se)

GlobalRV_2 <- FinalRV_2 %>% left_join(., CI) %>% 
  mutate(Brood = "B2")


```



## Brood of 3

```{r}
Data <- RAW_DATA %>% 
  filter(NIDADA == 3, PUESTA == 3, SEMANIPULO == "f") %>% Censoring(., 60)


CIBootLoop <- data.frame()

for (i in 1:1e3) {
  
  Datas <- resample(Data, replace = TRUE)
  
  RV <- Datas %>% mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~ 
                                         "A and B dind't died before C (q)")) %>% 
    mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>% 
    mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>% 
    select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>% 
    count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n)) 
  
  
  Total <- RV$Total[1]
  q <- RV %>% filter(q == "A and B dind't died before C (q)") %>% pull(Sum_q) %>% .[1]
  P <- RV %>% filter(q == "A and B dind't died before C (q)" & P == "All survived") %>% pull(n)
  
  `Total-q` <- Total - q
  Pi <- RV %>% filter(Pi == "C survived after A or B died") %>% pull(n)
  
  
  ### Percentage
  `%RVe` <- RVe * 100 / TotRV; `%RVe`
  `%RVi` <- RVi * 100 / TotRV; `%RVi`
  
  RVe_3 <- round(q/Total * P/q, digits = 3); RVe_3
  
  RVi_3 <- round((1 - q/Total) * Pi/`Total-q`, digits = 3); RVi_3
  
  dat <- data.frame(RV = c("RVe", "RVi"),
                    Reproductive_Value = c(RVe_3, RVi_3),
                    Perc = c(`%RVe`, `%RVi`))
  
  CIBootLoop <- rbind(CIBootLoop, dat)
  
  
}
CI <- CIBootLoop %>% group_by(RV) %>% 
  summarise(se = sd(Reproductive_Value), CI = 2 * se)

GlobalRV_3 <- FinalRV_3 %>% left_join(., CI) %>% 
  mutate(Brood = "B3")
```






# Plot
```{r}
X = "Global"
rbind(GlobalRV_2, GlobalRV_3) %>% 
  ggplot(aes(Brood, Reproductive_Value, fill = RV)) + 
  geom_col(position = position_dodge()) +
    geom_errorbar(aes(ymin= Reproductive_Value - CI, ymax= Reproductive_Value + CI), width=.09, size = 1.3,
                  position=position_dodge(1.5), color = "#524e49") + 
    scale_y_continuous(n.breaks = 7, limits = c(NA, 0.8)) +
    geom_text(aes(label = paste0(round(Perc, digits = 0),"%")), 
              position = position_dodge(width = 0.5), vjust = 0, size = 7) + 
    labs(x = "Brood size", y = "Reproductive value") + theme_minimal() + 
  theme(axis.title.y = element_text(size = 28),
        axis.text = element_text(size = 20),
        axis.title.x = element_text(size = 28),
        legend.title = element_text(size = 30),
        legend.text = element_text(size = 28), 
        plot.margin = unit(c(50, 30, 5.5, 5.5),"pt")) + 
    scale_fill_manual(values=c("#68A3A3", "#D7B67C")) + ggsave(str_glue("RV_2_{X}.png")); Plot

assign(str_glue("Plot_2_{X}"), Plot)
```















# FOR LOOP BROOD 2

### Filter data

```{r}
Tab <- RAW_DATA %>% 
  filter(NIDADA == 2, PUESTA == 2, SEMANIPULO == "f") %>% Censoring(., 60) %>% 
  mutate(gr_PrRank = cut_number(Periode_roundPrRank, n = 3)) %>% 
  mutate(gr_SST = cut_number(Periode_roundSST, n = 3)) %>% 
  mutate(gr_Fage = cut_number(AGEHEMB, n = 6)) %>% 
  mutate(gr_Mage = cut_number(AGEMACH, n = 6)) %>% 
  mutate(gr_Bond = if_else(CoupleExpLocal == 1, "First year", "Pair bond > 1")) %>% 
  rowwise() %>% 
  mutate(Diff_age = abs(AGEMACH - AGEHEMB)) %>% 
  ungroup() %>% 
  mutate(gr_Dage = cut_number(Diff_age, n = 3))
  

Tab %>% count(gr_PrRank)  

LoopResult <- data.frame()

### Age Difference ###-----------------------------------------------------------------------------------------------------------------------

# X <- "Age Difference"
# gr_Dage <- Tab$gr_Dage %>% unique() %>% sort() %>% na.omit()
# for (i in gr_Dage){
#   RV <- Tab %>%
#     filter(gr_Dage == i) %>%
#     mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
#     mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
#     mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
#     count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------

  
### Prop Rank ###-----------------------------------------------------------------------------------------------------------------------
X <- "Laying date"
gr_PrRank <- Tab %>% arrange(gr_PrRank) %>% .$gr_PrRank %>% unique() %>% na.omit()
for (i in gr_PrRank){
  RV <- Tab %>%
  filter(gr_PrRank == i) %>%
  mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
  mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
  mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
  count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------
  
### Pair bond ###-----------------------------------------------------------------------------------------------------------------------
# X <- "Pair bond duration"
# gr_Bond <- Tab$gr_Bond %>% unique() %>% sort() %>% na.omit()
# for (i in gr_Bond){
# RV <- Tab %>%
#   filter(gr_Bond == i) %>%
#   mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
#   mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
#   mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
#   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------

### Females ###-----------------------------------------------------------------------------------------------------------------------
# X <- "Female age"
# gr_Age <- Tab %>% arrange(AGEHEMB) %>% .$gr_Fage %>% unique() %>% na.omit()
# for (i in gr_Age){
# RV <- Tab %>%
#   filter(CONFIRMHEMB == "t") %>%
#   filter(gr_Fage == i) %>%
#   mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
#   mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
#   mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
#   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------


### Males ###-----------------------------------------------------------------------------------------------------------------------

# X <- "Male age"
# gr_Age <- Tab %>% arrange(AGEMACH) %>% .$gr_Mage %>% unique() %>% na.omit()
# for (i in gr_Age){
# RV <- Tab %>%
#   filter(CONFIRMMACH == "t") %>%
#   filter(gr_Mage == i) %>%
#   mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
#   mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
#   mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
#   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------


### SST ###-----------------------------------------------------------------------------------------------------------------------
# X <- "SST"
# gr_SST <- Tab %>% arrange(gr_SST) %>% .$gr_SST %>% unique() %>% na.omit()
# for (i in gr_SST){
#   RV <- Tab %>%
#   filter(gr_SST == i) %>%
#   mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
#   mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
#   mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
#   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------

## Values
Total <- RV$Total[1]
q <- RV %>% filter(q == "A dind't died before B (q)") %>% pull(Sum_q) %>% .[1]
P <- RV %>% filter(q == "A dind't died before B (q)" & P == "Both survived") %>% pull(n)

`Total-q` <- Total - q
Pi <- RV %>% filter(Pi == "B survived after A died") %>% pull(n)


## Mock equation
RVe <- round(q/Total * P/q, digits = 3); RVe

RVi <- round((1 - q/Total) * Pi/`Total-q`, digits = 3); RVi

TotRV <- RVe + RVi


### Percentage
`%RVe` <- RVe * 100 / TotRV; `%RVe`
`%RVi` <- RVi * 100 / TotRV; `%RVi`

dat <- data.frame(RV = c("RVe", "RVi"),
                  Filter = c(i),
                  Reproductive_Value = c(RVe, RVi),
                  Perc = c(`%RVe`, `%RVi`))

LoopResult <- rbind(LoopResult, dat)

}



###
### Calculate CI ###---------------------------------------------------------------------------------------------------------------------------------------------------
###

CIBootLoop <- data.frame()

### Age Difference ###-----------------------------------------------------------------------------------------------------------------------
# 
# for (y in 1:1e3) {
#   Tabs <- resample(Tab, replace = TRUE)
# 
#   LoopCIResult <- data.frame()
# 
#   for (i in gr_Dage){
#     RV <- Tabs %>%
#       filter(gr_Dage == i) %>%
#       mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
#       mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
#       mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
#       count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------
    
### Prop Rank ###-----------------------------------------------------------------------------------------------------------------------
for (y in 1:1e3) {
  Tabs <- resample(Tab, replace = TRUE)

  LoopCIResult <- data.frame()
  X <- "Laying date"
  gr_PrRank <- Tab %>% arrange(gr_PrRank) %>% .$gr_PrRank %>% unique() %>% na.omit()
  for (i in gr_PrRank){
    RV <- Tabs %>%
      filter(gr_PrRank == i) %>%
      mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
      mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
      mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
      count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------    
    
### Pair bond ###-----------------------------------------------------------------------------------------------------------------------
# for (y in 1:1e3) {
#   Tabs <- resample(Tab, replace = TRUE)
# 
#   LoopCIResult <- data.frame()
#   X <- "Pair bond duration"
#   gr_Bond <- Tab$gr_Bond %>% unique() %>% sort() %>% na.omit()
#   for (i in gr_Bond){
#     RV <- Tabs %>%
#       filter(gr_Bond == i) %>%
#       mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
#       mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
#       mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
#       count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------

### Females ###-----------------------------------------------------------------------------------------------------------------------
# for (y in 1:1e3) {
#   Tabs <- resample(Tab, replace = TRUE)
# 
#   LoopCIResult <- data.frame()
#   X <- "Female age"
#   gr_Age <- Tab %>% arrange(AGEHEMB) %>% .$gr_Fage %>% unique() %>% na.omit()
#   for (i in gr_Age){
#     RV <- Tabs %>%
#       filter(CONFIRMHEMB == "t") %>%
#       filter(gr_Fage == i) %>%
#       mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
#       mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
#       mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
#       count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------
    

### Males ###-----------------------------------------------------------------------------------------------------------------------
# for (y in 1:1e3) {
#   Tabs <- resample(Tab, replace = TRUE)
# 
#   LoopCIResult <- data.frame()
#   X <- "Male age"
#   gr_Age <- Tab %>% arrange(AGEMACH) %>% .$gr_Mage %>% unique() %>% na.omit()
#   for (i in gr_Age){
#     RV <- Tabs %>%
#       filter(CONFIRMMACH == "t") %>%
#       filter(gr_Mage == i) %>%
#       mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
#       mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
#       mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
#       count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------
    

### SST ###-----------------------------------------------------------------------------------------------------------------------
# for (y in 1:1e3) {
#   Tabs <- resample(Tab, replace = TRUE)
# 
#   LoopCIResult <- data.frame()
#   X <- "SST"
#   gr_SST <- Tab %>% arrange(gr_SST) %>% .$gr_SST %>% unique() %>% na.omit()
#   for (i in gr_SST){
#     RV <- Tabs %>%
#       filter(gr_SST == i) %>%
#       mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
#       mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
#       mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
#       count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------
    
    ## Values
    Total <- RV$Total[1]
    q <- RV %>% filter(q == "A dind't died before B (q)") %>% pull(Sum_q) %>% .[1]
    P <- RV %>% filter(q == "A dind't died before B (q)" & P == "Both survived") %>% pull(n)
    
    `Total-q` <- Total - q
    Pi <- RV %>% filter(Pi == "B survived after A died") %>% pull(n)
    
    
    ## Mock equation
    RVe <- round(q/Total * P/q, digits = 3); RVe
    
    RVi <- round((1 - q/Total) * Pi/`Total-q`, digits = 3); RVi
    
    if(length(RVi) == 0) next # Jump NA's
    
    TotRV <- RVe + RVi
    
    
    ### Percentage
    `%RVe` <- RVe * 100 / TotRV; `%RVe`
    `%RVi` <- RVi * 100 / TotRV; `%RVi`
    
    dat <- data.frame(RV = c("RVe", "RVi"),
                      Filter = c(i),
                      Reproductive_Value = c(RVe, RVi),
                      Perc = c(`%RVe`, `%RVi`))
    
    LoopCIResult <- rbind(LoopCIResult, dat)
    
  }
  CIBootLoop <- rbind(CIBootLoop, LoopCIResult)
}

CI <- CIBootLoop %>% group_by(RV, Filter) %>% 
  summarise(se = sd(Reproductive_Value), CI = 2 * se)

Plot <- LoopResult %>% left_join(., CI) %>% 
  mutate(x = 1:n()) %>% 
  ggplot(aes(reorder(Filter, x), Reproductive_Value, fill = RV)) + 
  geom_col(position = position_dodge()) +
    geom_errorbar(aes(ymin= Reproductive_Value - CI, ymax= Reproductive_Value + CI), width=.09, size = 1.3,
                  position=position_dodge(1.5), color = "#524e49") + 
    scale_y_continuous(n.breaks = 7, limits = c(NA, 0.8)) +
    geom_text(aes(label = paste0(round(Perc, digits = 0),"%")), 
              position = position_dodge(width = 0.5), vjust = 0, size = 7) + 
    labs(x = str_glue("{X}"), y = "Reproductive value") + theme_minimal() + 
  theme(axis.title.y = element_text(size = 28),
        axis.text = element_text(size = 20),
        axis.title.x = element_text(size = 28),
        legend.title = element_text(size = 30),
        legend.text = element_text(size = 28), 
        plot.margin = unit(c(50, 30, 5.5, 5.5),"pt")) + 
    scale_fill_manual(values=c("#68A3A3", "#D7B67C")) + ggsave(str_glue("RV_2_{X}.png")); Plot

assign(str_glue("Plot_2_{X}"), Plot)

```



# Sample size  
```{r}
Sample_size <- data.frame(Brood = c(2, 3),
           N = c(Sample_size_2, Sample_size_3))

# write_csv(Sample_size, "Sample_size.csv")
```











# FOR LOOP BROOD 3

### Filter data

```{r}
Tab <- RAW_DATA %>% 
  filter(NIDADA == 3, PUESTA == 3, SEMANIPULO == "f") %>% Censoring(., 60) %>% 
  mutate(gr_PrRank = cut_number(Periode_roundPrRank, n = 3)) %>% 
  mutate(gr_SST = cut_number(Periode_roundSST, n = 3)) %>% 
  mutate(gr_Fage = cut_number(AGEHEMB, n = 6)) %>% 
  mutate(gr_Mage = cut_number(AGEMACH, n = 6)) %>% 
  mutate(gr_Bond = if_else(CoupleExpLocal == 1, "First year", "Pair bond > 1")) %>% 
  rowwise() %>% 
  mutate(Diff_age = abs(AGEMACH - AGEHEMB)) %>% 
  ungroup() %>% 
  mutate(gr_Dage = cut_number(Diff_age, n = 3))  
  
Tab %>% count(gr_Mage)  

LoopResult <- data.frame()

### Age Difference ###-----------------------------------------------------------------------------------------------------------------------
# X <- "Age Difference"
# gr_Dage <- Tab$gr_Dage %>% unique() %>% sort() %>% na.omit()
# for (i in gr_Dage){
# RV <- Tab %>%
#   filter(gr_Dage == i) %>%
#   mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                          "A and B dind't died before C (q)")) %>%
#   mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
#   mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
#   select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
#   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------


### Prop Rank ###-----------------------------------------------------------------------------------------------------------------------
X <- "Laying date"
gr_PrRank <- Tab %>% arrange(gr_PrRank) %>% .$gr_PrRank %>% unique() %>% na.omit()
for (i in gr_PrRank){
  RV <- Tab %>%
  filter(gr_PrRank == i) %>%
    mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
                           "A and B dind't died before C (q)")) %>%
    mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
    mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
    select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
    count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------

### Pair bond ###-----------------------------------------------------------------------------------------------------------------------

# X <- "Pair bond duration"
# gr_Bond <- Tab$gr_Bond %>% unique() %>% sort() %>% na.omit()
# for (i in gr_Bond){
# RV <- Tab %>%
#   filter(gr_Bond == i) %>%
#   mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                          "A and B dind't died before C (q)")) %>%
#   mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
#   mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
#   select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
#   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------

### Females ###-----------------------------------------------------------------------------------------------------------------------

# X <- "Female age"
# gr_Age <- Tab %>% arrange(AGEHEMB) %>% .$gr_Fage %>% unique() %>% na.omit()
# for (i in gr_Age){
# RV <- Tab %>%
#   filter(CONFIRMHEMB == "t") %>%
#   filter(gr_Fage == i) %>%
#   mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                          "A and B dind't died before C (q)")) %>%
#   mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
#   mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
#   select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
#   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------


### Males ###-----------------------------------------------------------------------------------------------------------------------

# X <- "Male age"
# gr_Age <- Tab %>% arrange(AGEMACH) %>% .$gr_Mage %>% unique() %>% na.omit()
# for (i in gr_Age){
# RV <- Tab %>%
#   filter(CONFIRMMACH == "t") %>%
#   filter(gr_Mage == i) %>%
#   mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                          "A and B dind't died before C (q)")) %>%
#   mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
#   mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
#   select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
#   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------


### SST ###-----------------------------------------------------------------------------------------------------------------------

# X <- "SST"
# gr_SST <- Tab %>% arrange(gr_SST) %>% .$gr_SST %>% unique() %>% na.omit()
# for (i in gr_SST){
#   RV <- Tab %>%
#   filter(gr_SST == i) %>%
#     mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                            "A and B dind't died before C (q)")) %>%
#     mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
#     mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
#     select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
#     count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------
  
## Values
Total <- RV$Total[1]
q <- RV %>% filter(q == "A and B dind't died before C (q)") %>% pull(Sum_q) %>% .[1]
P <- RV %>% filter(q == "A and B dind't died before C (q)" & P == "All survived") %>% pull(n)

`Total-q` <- Total - q
Pi <- RV %>% filter(Pi == "C survived after A or B died") %>% pull(n)


## Mock equation
RVe <- round(q/Total * P/q, digits = 3); RVe

RVi <- round((1 - q/Total) * Pi/`Total-q`, digits = 3); RVi

TotRV <- RVe + RVi


### Percentage
`%RVe` <- RVe * 100 / TotRV; `%RVe`
`%RVi` <- RVi * 100 / TotRV; `%RVi`

dat <- data.frame(RV = c("RVe", "RVi"),
                  Filter = c(i),
                  Reproductive_Value = c(RVe, RVi),
                  Perc = c(`%RVe`, `%RVi`))

LoopResult <- rbind(LoopResult, dat)

}




###
### Calculate CI ###---------------------------------------------------------------------------------------------------------------------------------------------------
###

CIBootLoop <- data.frame()

### Age Difference ###-----------------------------------------------------------------------------------------------------------------------

# for (y in 1:1e3) {
#   Tabs <- resample(Tab, replace = TRUE)
# 
#   LoopCIResult <- data.frame()
# 
#   for (i in gr_Dage){
#     RV <- Tabs %>%
#       filter(gr_Dage == i) %>%
#      mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                            "A and B dind't died before C (q)")) %>%
#     mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
#     mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
#     select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
#     count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------
  
### Prop Rank ###-----------------------------------------------------------------------------------------------------------------------
for (y in 1:1e3) {
  Tabs <- resample(Tab, replace = TRUE)

  LoopCIResult <- data.frame()
  X <- "Laying date"
  gr_PrRank <- Tab %>% arrange(gr_PrRank) %>% .$gr_PrRank %>% unique() %>% na.omit()
  for (i in gr_PrRank){
    RV <- Tabs %>%
      filter(gr_PrRank == i) %>%
      mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
                             "A and B dind't died before C (q)")) %>%
      mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
      mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
      select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
      count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------
    
    
### Pair bond ###-----------------------------------------------------------------------------------------------------------------------

# for (y in 1:1e3) {
#   Tabs <- resample(Tab, replace = TRUE)
# 
#   LoopCIResult <- data.frame()
#   X <- "Pair bond duration"
#   gr_Bond <- Tab$gr_Bond %>% unique() %>% sort() %>% na.omit()
#   for (i in gr_Bond){
#     RV <- Tabs %>%
#       filter(gr_Bond == i) %>%
#       mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                              "A and B dind't died before C (q)")) %>%
#       mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
#       mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
#       select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
#       count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------

### Females ###-----------------------------------------------------------------------------------------------------------------------
# for (y in 1:1e3) {
#   Tabs <- resample(Tab, replace = TRUE)
# 
#   LoopCIResult <- data.frame()
#   X <- "Female age"
#   gr_Age <- Tab %>% arrange(AGEHEMB) %>% .$gr_Fage %>% unique() %>% na.omit()
#   for (i in gr_Age){
#     RV <- Tabs %>%
#       filter(CONFIRMHEMB == "t") %>%
#       filter(gr_Fage == i) %>%
#       mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                              "A and B dind't died before C (q)")) %>%
#       mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
#       mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
#       select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
#       count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------
    

### Males ###-----------------------------------------------------------------------------------------------------------------------
# for (y in 1:1e3) {
#   Tabs <- resample(Tab, replace = TRUE)
# 
#   LoopCIResult <- data.frame()
#   X <- "Male age"
#   gr_Age <- Tab %>% arrange(AGEMACH) %>% .$gr_Mage %>% unique() %>% na.omit()
#   for (i in gr_Age){
#     RV <- Tabs %>%
#       filter(CONFIRMMACH == "t") %>%
#       filter(gr_Mage == i) %>%
#       mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                        "A and B dind't died before C (q)")) %>%
# mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
# mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
# select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
# count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------
    

### SST ###-----------------------------------------------------------------------------------------------------------------------
# for (y in 1:1e3) {
#   Tabs <- resample(Tab, replace = TRUE)
# 
#   LoopCIResult <- data.frame()
#   X <- "SST"
#   gr_SST <- Tab %>% arrange(gr_SST) %>% .$gr_SST %>% unique() %>% na.omit()
#   for (i in gr_SST){
#     RV <- Tabs %>%
#       filter(gr_SST == i) %>%
#       mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                              "A and B dind't died before C (q)")) %>%
#       mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
#       mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
#       select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
#       count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------
    
    ## Values
    Total <- RV$Total[1]
    q <- RV %>% filter(q == "A and B dind't died before C (q)") %>% pull(Sum_q) %>% .[1]
    P <- RV %>% filter(q == "A and B dind't died before C (q)" & P == "All survived") %>% pull(n)
    
    `Total-q` <- Total - q
    Pi <- RV %>% filter(Pi == "C survived after A or B died") %>% pull(n)
    
    
    ## Mock equation
    RVe <- round(q/Total * P/q, digits = 3); RVe
    
    RVi <- round((1 - q/Total) * Pi/`Total-q`, digits = 3); RVi
    
    if(length(RVi) == 0) next # Jump NA's
    
    TotRV <- RVe + RVi
    
    
    ### Percentage
    `%RVe` <- RVe * 100 / TotRV; `%RVe`
    `%RVi` <- RVi * 100 / TotRV; `%RVi`
    
    dat <- data.frame(RV = c("RVe", "RVi"),
                      Filter = c(i),
                      Reproductive_Value = c(RVe, RVi),
                      Perc = c(`%RVe`, `%RVi`))
    
    LoopCIResult <- rbind(LoopCIResult, dat)
    
  }
  CIBootLoop <- rbind(CIBootLoop, LoopCIResult)
}

CI <- CIBootLoop %>% group_by(RV, Filter) %>% 
  summarise(se = sd(Reproductive_Value), CI = 2 * se, ci = confint(Reproductive_Value, level = 0.95, method = "quantile")) 

ci <- CI %>% cbind(CI$ci) %>% select(-5) %>% rename(ymin = `2.5%`, ymax =  `97.5%`)

Plot <- LoopResult %>% left_join(., ci) %>% 
  mutate(x = 1:n()) %>% 
  ggplot(aes(reorder(Filter, x), Reproductive_Value, fill = RV)) + 
  geom_col(position = position_dodge()) +
    geom_errorbar(aes(ymin= Reproductive_Value - CI, ymax= Reproductive_Value + CI), width=.09, size = 1.3,
                  position=position_dodge(1.5), color = "#524e49") + 
    scale_y_continuous(n.breaks = 7, limits = c(NA, 0.8)) +
    geom_text(aes(label = paste0(round(Perc, digits = 0),"%")), 
              position = position_dodge(width = 0.5), vjust = 0, size = 7) + 
    labs(x = str_glue("{X}"), y = "Reproductive value") + theme_minimal() + 
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 20),
        axis.title.x = element_text(size = 28),
        plot.margin = unit(c(50, 5.5, 5.5, 30),"pt")) + 
    scale_fill_manual(values=c("#68A3A3", "#D7B67C")) + ggsave(str_glue("RV_3_{X}.png")); Plot



assign(str_glue("Plot_3_{X}"), Plot)


```








# Arrange results 

```{r}

`Plot_2_Female ages` <- `Plot_2_Female age` + ggtitle("RV of chick B from broods of two") + theme(plot.title = element_text(hjust = 0.5, size = 34),
        plot.margin = unit(c(10, 5.5, 5.5, 5.5),"pt"))
`Plot_3_Female ages` <- `Plot_3_Female age` + ggtitle("RV of chick C from broods of three") + 
  theme(plot.title = element_text(hjust = 0.5, size = 34),
        plot.margin = unit(c(10, 5.5, 5.5, 5.5),"pt"))

ggarrange(`Plot_2_Female ages`, 
          `Plot_3_Female ages`, 
          `Plot_2_Male age`, 
          `Plot_3_Male age`, 
          `Plot_2_Pair bond duration`, 
          `Plot_3_Pair bond duration`, 
          Plot_2_SST, 
          Plot_3_SST,
  common.legend = TRUE, legend = "bottom",
  ncol = 2, nrow = 4,
  labels = letters[seq(1, 8)],
  font.label = list(size = 38, color = "black", face = "bold", family = NULL),
  hjust = -1,
  vjust = 1
  ) %>%
  ggexport(filename = "ReproductiveValueArrange_CI.png", width = 1500, height = 1700)

```


# Arrange SUPP results 

```{r}
`Plot_2_Laying date` <- `Plot_2_Laying date` + ggtitle("RV of chick B from broods of two") + theme(plot.title = element_text(hjust = 0.5, size = 34),
        plot.margin = unit(c(10, 5.5, 5.5, 5.5),"pt"))
`Plot_3_Laying date` <- `Plot_3_Laying date` + ggtitle("RV of chick C from broods of three") + 
  theme(plot.title = element_text(hjust = 0.5, size = 34),
        plot.margin = unit(c(10, 5.5, 5.5, 5.5),"pt"))

ggarrange(`Plot_2_Laying date`, 
          `Plot_3_Laying date`, 
          Plot_2_SST, 
          Plot_3_SST,
  common.legend = TRUE, legend = "bottom",
  ncol = 2, nrow = 4,
  labels = letters[seq(1, 8)],
  font.label = list(size = 38, color = "black", face = "bold", family = NULL),
  hjust = -1,
  vjust = 1
  ) %>%
  ggexport(filename = "ReproductiveValueArrange_CISupp.png", width = 1500, height = 1700)
```






# END















# Sample size  
```{r}
Sample_size <- data.frame(Brood = c(2, 3),
           N = c(Sample_size_2, Sample_size_3))

# write_csv(Sample_size, "Sample_size.csv")

Tab %>% count(gr_SST)
```


# Bootsrap CI

# FOR LOOP CI 2

### Filter data

```{r}
Tab <- RAW_DATA %>% 
  filter(NIDADA == 2, PUESTA == 2, SEMANIPULO == "f") %>% Censoring(., 60) %>% 
  filter(!(DESTHUEVO2 == "e" & ESTECLOS2 <= ESTECLOS1)) %>% 
  mutate(gr_SST = cut_number(Periode_roundSST, n = 3)) %>% 
  mutate(gr_Fage = cut_number(AGEHEMB, n = 6)) %>% 
  mutate(gr_Mage = cut_number(AGEMACH, n = 6)) %>% 
  mutate(gr_Bond = if_else(CoupleExpLocal == 1, "First year", "Pair bond > 1")) %>% 
  rowwise() %>% 
  mutate(Diff_age = abs(AGEMACH - AGEHEMB)) %>% 
  ungroup() %>% 
  mutate(gr_Dage = cut_number(Diff_age, n = 3))


Tab %>% count(gr_Mage)  

CIBootLoop <- data.frame()

### Age Difference ###-----------------------------------------------------------------------------------------------------------------------

X <- "Age Difference"
gr_Dage <- Tab$gr_Dage %>% unique() %>% sort() %>% na.omit()

for (y in 1:2) {
  Tabs <- resample(Tab, replace = TRUE)
  
  LoopCIResult <- data.frame()  
  
  for (i in gr_Dage){
    RV <- Tabs %>%
      filter(gr_Dage == i) %>%
      mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
      mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
      mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
      count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
    #-----------------------------------------------------------------------------------------------------------------------
    
    
    
    ### Pair bond ###-----------------------------------------------------------------------------------------------------------------------
    
    # X <- "Pair bond duration"
    # gr_Bond <- Tab$gr_Bond %>% unique() %>% sort() %>% na.omit()
    # for (i in gr_Bond){
    # RV <- Tab %>%
    #   filter(gr_Bond == i) %>%
    #   mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
    #   mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
    #   mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
    #   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
    #-----------------------------------------------------------------------------------------------------------------------
    
    ### Females ###-----------------------------------------------------------------------------------------------------------------------
    
    # X <- "Female age"
    # gr_Age <- Tab %>% arrange(AGEHEMB) %>% .$gr_Fage %>% unique() %>% na.omit()
    # for (i in gr_Age){
    # RV <- Tab %>%
    #   filter(CONFIRMHEMB == "t") %>%
    #   filter(gr_Fage == i) %>%
    #   mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
    #   mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
    #   mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
    #   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
    #-----------------------------------------------------------------------------------------------------------------------
    
    
    ### Males ###-----------------------------------------------------------------------------------------------------------------------
    
    # X <- "Male age"
    # gr_Age <- Tab %>% arrange(AGEMACH) %>% .$gr_Mage %>% unique() %>% na.omit()
    # for (i in gr_Age){
    # RV <- Tab %>%
    #   filter(CONFIRMMACH == "t") %>%
    #   filter(gr_Mage == i) %>%
    #   mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
    #   mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
    #   mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
    #   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
    #-----------------------------------------------------------------------------------------------------------------------
    
    
    ### SST ###-----------------------------------------------------------------------------------------------------------------------
    
    # X <- "SST"
    # gr_SST <- Tab %>% arrange(gr_SST) %>% .$gr_SST %>% unique() %>% na.omit()
    # for (i in gr_SST){
    #   RV <- Tab %>%
    #   filter(gr_SST == i) %>% 
    #   mutate(q = case_when(!(FECHFINAL1 < FECHFINAL2 & MURIO1 == "t") ~ "A dind't died before B (q)")) %>%
    #   mutate(P = case_when(q == "A dind't died before B (q)" & MURIO2 == "f" ~ "Both survived")) %>%
    #   mutate(Pi = case_when(is.na(q) & MURIO2 == "f" ~ "B survived after A died")) %>%
    #   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
    #-----------------------------------------------------------------------------------------------------------------------
    
    ## Values
    Total <- RV$Total[1]
    q <- RV %>% filter(q == "A dind't died before B (q)") %>% pull(Sum_q) %>% .[1]
    P <- RV %>% filter(q == "A dind't died before B (q)" & P == "Both survived") %>% pull(n)
    
    `Total-q` <- Total - q
    Pi <- RV %>% filter(Pi == "B survived after A died") %>% pull(n)
    
    
    ## Mock equation
    RVe <- round(q/Total * P/q, digits = 3); RVe
    
    RVi <- round((1 - q/Total) * Pi/`Total-q`, digits = 3); RVi
    
    TotRV <- RVe + RVi
    
    
    ### Percentage
    `%RVe` <- RVe * 100 / TotRV; `%RVe`
    `%RVi` <- RVi * 100 / TotRV; `%RVi`
    
    dat <- data.frame(RV = c("RVe", "RVi"),
                      Filter = c(i),
                      Reproductive_Value = c(RVe, RVi),
                      Perc = c(`%RVe`, `%RVi`))
    
    LoopCIResult <- rbind(LoopCIResult, dat)
    
  }
  CIBootLoop <- rbind(CIBootLoop, LoopCIResult)
}

CI <- CIBootLoop %>% group_by(RV, Filter) %>% 
  summarise(se = sd(Reproductive_Value), CI = 2 * se, ci = confint(Reproductive_Value, level = 0.95, method = "quantile")) 
ci <- CI %>% cbind(CI$ci) %>% select(-5) 

Plot <- LoopResult %>% left_join(., CI) %>% 
  mutate(x = 1:n()) %>% 
  ggplot(aes(reorder(Filter, x), Reproductive_Value, fill = RV)) + 
  geom_col(position = position_dodge()) +
    geom_errorbar(aes(ymin= Reproductive_Value - CI, ymax = Reproductive_Value + CI), width=.09, size = 1,
                  position=position_dodge(1.1), color = "#524e49") + 
    scale_y_continuous(n.breaks = 8) +
    geom_text(aes(label = paste0(round(Perc, digits = 0),"%")), 
              position = position_dodge(width = 0.7), vjust = 0) + 
    labs(x = str_glue("{X}"), y = "Reproductive value") + theme_minimal() + ggsave(str_glue("RV_3_{X}.png")) + 
  ylim(0, 0.7) +
    scale_fill_manual(values=c("#68A3A3", "#D7B67C")); Plot

```











# Plot loop distribution

```{r}
CI <- CIBootLoop %>% group_by(RV, Filter) %>% 
  summarise(se = sd(Reproductive_Value), CI = 2 * se)

Plot <- LoopResult %>% left_join(., CI) %>% 
  mutate(x = 1:n()) %>% 
  ggplot(aes(reorder(Filter, x), Reproductive_Value, fill = RV)) + 
  geom_col(position = position_dodge()) +
    geom_errorbar(aes(ymin= Reproductive_Value - CI, ymax= Reproductive_Value + CI), width=.09, size = 1,
                  position=position_dodge(1.1), color = "#524e49") + 
    scale_y_continuous(n.breaks = 7) +
    geom_text(aes(label = paste0(round(Perc, digits = 0),"%")), 
              position = position_dodge(width = 0.7), vjust = 0) + 
    labs(x = str_glue("{X}"), y = "Reproductive value") + theme_minimal() + ggsave(str_glue("RV_3_{X}.png")) + 
    scale_fill_manual(values=c("#68A3A3", "#D7B67C")); Plot
```


```{r}
# Check bootstrap distribution
CIBootLoop %>% filter(RV == "RVe", Filter == "[0,1]") %>% 
  ggplot(aes(Reproductive_Value)) + geom_histogram()

# Calculate se
test <- CIBootLoop %>% filter(RV == "RVe", Filter == "[0,1]")
SE <- sd(test$Reproductive_Value)


# Caluculate CI

confint(test$Reproductive_Value, level = 0.95, method = "bootstrap-t")
```





# Sample size  
```{r}
Sample_size <- data.frame(Brood = c(2, 3),
           N = c(Sample_size_2, Sample_size_3))

# write_csv(Sample_size, "Sample_size.csv")
```











# FOR LOOP CI 3

### Filter data

```{r}
Tab <- RAW_DATA %>% 
  filter(NIDADA == 3, PUESTA == 3, SEMANIPULO == "f") %>% Censoring(., 60) %>% 
  filter(!(DESTHUEVO2 == "e" & ESTECLOS2 <= ESTECLOS1)) %>% 
  mutate(gr_SST = cut_number(Periode_roundSST, n = 3)) %>% 
  mutate(gr_Fage = cut_number(AGEHEMB, n = 6)) %>% 
  mutate(gr_Mage = cut_number(AGEMACH, n = 6)) %>% 
  mutate(gr_Bond = if_else(CoupleExpLocal == 1, "First year", "Pair bond > 1")) %>% 
  rowwise() %>% 
  mutate(Diff_age = abs(AGEMACH - AGEHEMB)) %>% 
  ungroup() %>% 
  mutate(gr_Dage = cut_number(Diff_age, n = 3))  
  
Tab %>% count(gr_Dage)  

LoopResult <- data.frame()

### Age Difference ###-----------------------------------------------------------------------------------------------------------------------

# X <- "Age Difference"
# gr_Dage <- Tab$gr_Dage %>% unique() %>% sort() %>% na.omit()
# for (i in gr_Dage){
# RV <- Tab %>%
#   filter(gr_Dage == i) %>%
#   mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                          "A and B dind't died before C (q)")) %>%
#   mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
#   mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
#   select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
#   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------



### Pair bond ###-----------------------------------------------------------------------------------------------------------------------

# X <- "Pair bond duration"
# gr_Bond <- Tab$gr_Bond %>% unique() %>% sort() %>% na.omit()
# for (i in gr_Bond){
# RV <- Tab %>%
#   filter(gr_Bond == i) %>%
#   mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                          "A and B dind't died before C (q)")) %>%
#   mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
#   mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
#   select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
#   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------

### Females ###-----------------------------------------------------------------------------------------------------------------------

# X <- "Female age"
# gr_Age <- Tab %>% arrange(AGEHEMB) %>% .$gr_Fage %>% unique() %>% na.omit()
# for (i in gr_Age){
# RV <- Tab %>%
#   filter(CONFIRMHEMB == "t") %>%
#   filter(gr_Fage == i) %>%
#   mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                          "A and B dind't died before C (q)")) %>%
#   mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
#   mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
#   select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
#   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------


### Males ###-----------------------------------------------------------------------------------------------------------------------

# X <- "Male age"
# gr_Age <- Tab %>% arrange(AGEMACH) %>% .$gr_Mage %>% unique() %>% na.omit()
# for (i in gr_Age){
# RV <- Tab %>%
#   filter(CONFIRMMACH == "t") %>%
#   filter(gr_Mage == i) %>%
#   mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                          "A and B dind't died before C (q)")) %>%
#   mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
#   mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
#   select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
#   count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------


### SST ###-----------------------------------------------------------------------------------------------------------------------

# X <- "SST"
# gr_SST <- Tab %>% arrange(gr_SST) %>% .$gr_SST %>% unique() %>% na.omit()
# for (i in gr_SST){
#   RV <- Tab %>%
#   filter(gr_SST == i) %>%
#     mutate(q = case_when(!((FECHFINAL1 < FECHFINAL3 & MURIO1 == "t") | (FECHFINAL2 < FECHFINAL3 & MURIO2 == "t")) ~
#                            "A and B dind't died before C (q)")) %>%
#     mutate(P = case_when(q == "A and B dind't died before C (q)" & MURIO3 == "f" ~ "All survived")) %>%
#     mutate(Pi = case_when(is.na(q) & MURIO3 == "f" ~ "C survived after A or B died")) %>%
#     select(contains(c("FECHFINAL", "MURIO")), q, P, Pi) %>%
#     count(q, P, Pi) %>% as.data.frame() %>% mutate(Total = sum(n)) %>% group_by(q) %>% mutate(Sum_q = sum(n))
#-----------------------------------------------------------------------------------------------------------------------
  
## Values
Total <- RV$Total[1]
q <- RV %>% filter(q == "A and B dind't died before C (q)") %>% pull(Sum_q) %>% .[1]
P <- RV %>% filter(q == "A and B dind't died before C (q)" & P == "All survived") %>% pull(n)

`Total-q` <- Total - q
Pi <- RV %>% filter(Pi == "C survived after A or B died") %>% pull(n)


## Mock equation
RVe <- round(q/Total * P/q, digits = 3); RVe

RVi <- round((1 - q/Total) * Pi/`Total-q`, digits = 3); RVi

TotRV <- RVe + RVi


### Percentage
`%RVe` <- RVe * 100 / TotRV; `%RVe`
`%RVi` <- RVi * 100 / TotRV; `%RVi`

dat <- data.frame(RV = c("RVe", "RVi"),
                  Filter = c(i),
                  Reproductive_Value = c(RVe, RVi),
                  Perc = c(`%RVe`, `%RVi`))

LoopResult <- rbind(LoopResult, dat)

}


```








```{r}
knitr::include_graphics("ReproductiveValueArrange.png")
```

































## Lameley equation
Because we need to take in consideration random survival it could be interesting to calculate the real insurance value following lamey paper [@lamey_insurance_1996]

where:
B = brood size (2)
t = number of days in the nestling cycle (60) 
s = proportion of nest where all senior offspring survived 
a = proportion of nest in which all young survived


```{r eval=FALSE}
# Determinate B and t

B = 3
t = 60

# Calculate s and a
MiniMother <- RAW_DATA %>% filter(NIDADA == B, PUESTA == B, SEMANIPULO == "f") %>%
  Censoring(., t)  

df %>% count(Death602)

# s
dfS <- MiniMother %>% count(Death601) %>% drop_na() %>% janitor::adorn_totals()

`s*` <- dfS %>% 
  filter(Death601 == "0") %>% pull(n)
sT <- dfS %>% 
  filter(Death601 == "Total") %>% pull(n)

s <- `s*`/sT

# a
dfA <- MiniMother %>% count(Death602) %>% drop_na() %>% janitor::adorn_totals()
`a*` <- dfA %>% 
  filter(Death602 == "0") %>% pull(n)
aT <- dfA %>% 
  filter(Death602 == "Total") %>% pull(n)

a <- `a*`/aT


# Calculate s and a for each day

# s
dfS <- MiniMother %>% count(Time601) %>% drop_na() %>%  filter(!Time601 < 0) %>% 
  arrange(Time601) %>% 
  mutate(nsum = (cumsum(n))) %>% 
  mutate(Tot_nsum = .[61, 3] - nsum) %>% 
  # mutate(nsum = replace(nsum, is.na(nsum), 0)) %>% 
  mutate(perc = n/(.[61, 3] - nsum)) %>% 
  mutate(perc = 1 - perc) %>% 
  janitor::adorn_totals()

s <- dfS %>% slice(-61, -62) %>% pull(perc)

# a
dfA <- MiniMother %>% count(Time602) %>% drop_na() %>%  filter(!Time602 < 0) %>% 
  arrange(Time602) %>% 
  mutate(nsum = (cumsum(n))) %>% 
  janitor::adorn_totals() %>% 
  mutate(Tot_nsum = .[62,2] - nsum) %>% 
  # mutate(nsum = replace(nsum, is.na(nsum), 0)) %>% 
  mutate(perc = n/(.[62,2] - nsum)) %>% 
  mutate(perc = 1 - perc) 

a <- dfS %>% slice(-61, -62) %>% pull(perc)
```

### Calculate i and d
```{r eval=FALSE}
# at 60 days
t <- 1:59
i = 1 - (s^(1 / (t * (B - 1)))) 
d = 1 - ( a^(1 / t) / (1 - i)^B ) 


# at each day

```



### Calculate RVe, RVi and RVs
```{r eval=FALSE}
RVe <- ((1 - i) * (1 - d))^t * ((1 - i)^(B - 1))^t 

x <- 1:(t)

RVi <- sum( ((1 - i) * (1 - d))^x * ((1 - i)^(B - 1))^(x - 1) * (1 - (1 - i)^(B - 1)) * (1 - i)^(t - x), na.rm = T)

RVl <- sum( ((1 - i) * (1 - d))^x * ((1 - i)^(B - 1))^(x - 1) * (1 - (1 - i)^(B - 1)) * ((1 - i) * (1 - d))^(t - x), na.rm = T)


RVs <- sum( ((1 - i) * (1 - d))^x * ((1 - i)^(B - 1))^(x - 1) * (1 - (1 - i)^(B - 1)) * ((1 - i)^(t - x) - ((1 - i) * (1 - d))^(t - x)) )

RVi - RVl
RVs + RVl
```

# Plot type 2

```{r}
Plot <- LoopResult %>% mutate(x = 1:n()) %>% 
  ggplot(aes(reorder(Filter, x), Reproductive_Value, fill = RV)) + geom_col(position = "dodge") + 
  scale_y_continuous(n.breaks = 15) +
  geom_text(aes(label = paste0(round(Perc, digits = 0),"%")), position = position_dodge(width = 0.9), vjust = 1.5) + 
  labs(x = str_glue("{X}"), y = "Reproductive value") + theme_minimal() + ggsave(str_glue("RV_3_{X}.png"))
```

